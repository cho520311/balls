<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°ç«¹é­šä¸¸æ¡è³¼ç³»çµ± (å…¨åŠŸèƒ½é–‹æ”¾ç‰ˆ)</title>
    <style>
        :root { --primary: #2e59a7; --secondary: #f39c12; --danger: #ff4d4d; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f0f2f5; padding: 10px; margin: 0; }
        
        /* å®¹å™¨å„ªåŒ–ï¼šç¢ºä¿æ‰‹æ©Ÿç‰ˆå¡«æ»¿å¯¬åº¦ */
        .card, .summary-card { 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto 15px auto; 
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            box-sizing: border-box; 
        }
        
        h2, h3 { text-align: center; color: var(--primary); margin: 10px 0; }
        
        /* è¡¨å–®å€åŸŸ */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        /* å“é …åˆ—è¡¨å„ªåŒ– */
        .item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .item span { font-size: 15px; flex: 1; }
        select { padding: 8px; border-radius: 6px; font-size: 16px; width: 85px; background: #fff; border: 1px solid #ccc; }
        
        .total-row { text-align: right; color: #d9534f; font-size: 20px; font-weight: bold; margin: 15px 0; }
        .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn:disabled { background: #ccc; }

        /* åº—å®¶ç¸½å–®çµ±è¨ˆå€ (å…¨é–‹æ”¾) */
        .summary-card { background: #fff3e0; border: 2px solid var(--secondary); }
        .summary-item { display: flex; justify-content: space-between; padding: 6px 0; font-weight: bold; color: #e67e22; border-bottom: 1px dashed #ffe0b2; }
        
        /* è¡¨æ ¼å„ªåŒ–ï¼šé˜²æ­¢æ‰‹æ©Ÿç‰ˆæº¢å‡º */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 450px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; color: var(--primary); }
        .del-btn { background: var(--danger); color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px; }

        /* æ‰‹æ©Ÿç‰ˆå­—é«”èˆ‡é–“è·å¾®èª¿ */
        @media (max-width: 480px) {
            body { padding: 8px; }
            .card, .summary-card { padding: 12px; }
            .item span { font-size: 14px; }
            select { width: 75px; font-size: 15px; }
            h2 { font-size: 20px; }
        }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸš æ–°ç«¹é­šä¸¸æ¡è³¼ç™»è¨˜</h2>
    <div class="input-group">
        <label>è¨‚è³¼äººå§“åï¼š</label>
        <input type="text" id="userName" placeholder="è«‹è¼¸å…¥å§“å">
    </div>
    
    <div id="productArea"></div>
    
    <div class="total-row">ç¸½è¨ˆ: <span id="displayTotal">0</span> å…ƒ</div>
    <button class="btn" id="sendBtn" onclick="submitOrder()">ç¢ºèªé€å‡ºè¨‚å–®</button>
</div>

<div class="summary-card">
    <h3>ğŸª åº—å®¶ç¸½å–®çµ±è¨ˆ (å«è²¨ç”¨)</h3>
    <div id="shopSummary">æ­£åœ¨å¾é›²ç«¯æŠ“å–è³‡æ–™...</div>
    <div class="summary-item" style="font-size: 18px; border: none; margin-top: 10px;">
        <span>é è¨ˆæ”¶æ¬¾ç¸½é¡ï¼š</span>
        <span>NT$ <span id="allMoney">0</span></span>
    </div>
</div>

<div class="card">
    <h3>ğŸ“Š å³æ™‚è¨‚å–®æ˜ç´° (å¯åˆªé™¤)</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>å§“å</th>
                    <th>è¨‚è³¼å…§å®¹</th>
                    <th>æ™‚é–“</th>
                    <th>ç®¡ç†</th>
                </tr>
            </thead>
            <tbody id="detailTable">
                <tr><td colspan="4" style="text-align:center;">è®€å–ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const gasUrl = 'https://script.google.com/macros/s/AKfycbx_ixNSXTbuZ6aTdO0C0q82rSV3fj06psMqA0070UFEfaeL4HQqlPIZNjRyuAb2QBwJVA/exec'; // ğŸ‘ˆ è«‹å‹™å¿…æ›¿æ›ç‚ºæ–°çš„ GAS ç¶²å€

    const products = [
        { name: "åŒ…é¤¡é­šä¸¸", price: 170 },
        { name: "ç„¡åŒ…é¤¡é­šä¸¸", price: 150 },
        { name: "åŸå‘³è²¢ä¸¸", price: 190 },
        { name: "é¦™è‡è²¢ä¸¸", price: 190 },
        { name: "ç¦å·ç‡•ä¸¸", price: 220 },
        { name: "é®®è”¥è²¢ä¸¸", price: 220 }
    ];

    // åˆå§‹åŒ–é¸å–® (0-10)
    const area = document.getElementById('productArea');
    products.forEach((p, i) => {
        let opt = '';
        for(let j=0; j<=10; j++) opt += `<option value="${j}">${j}</option>`;
        area.innerHTML += `
            <div class="item">
                <span><b>${p.name}</b><br><small>${p.price}å…ƒ/æ–¤</small></span>
                <select class="qty" data-idx="${i}" onchange="calcTotal()">${opt}</select>
            </div>`;
    });

    function calcTotal() {
        let total = 0;
        document.querySelectorAll('.qty').forEach(s => {
            total += parseInt(s.value) * products[s.dataset.idx].price;
        });
        document.getElementById('displayTotal').innerText = total;
    }

    async function loadOrders() {
        try {
            const res = await fetch(gasUrl);
            const data = await res.json();
            const table = document.getElementById('detailTable');
            const summary = document.getElementById('shopSummary');
            table.innerHTML = '';
            summary.innerHTML = '';
            
            let stats = {};
            products.forEach(p => stats[p.name] = 0);
            let totalMoney = 0;

            if (data.length === 0) {
                table.innerHTML = '<tr><td colspan="4" style="text-align:center;">ç›®å‰å°šç„¡è¨‚å–®</td></tr>';
                summary.innerHTML = 'å°šç„¡çµ±è¨ˆè³‡æ–™';
                return;
            }

            // åè½‰é™£åˆ—è®“æœ€æ–°è¨‚å–®åœ¨ä¸Šé¢
            data.slice().reverse().forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row[0]}</td>
                    <td>${row[1]}</td>
                    <td>${row[3]}</td>
                    <td><button class="del-btn" onclick="deleteOrder('${row[0]}','${row[3]}')">åˆªé™¤</button></td>
                `;
                table.appendChild(tr);
                
                // çµ±è¨ˆå„å“é …æ•¸é‡
                products.forEach(p => {
                    const match = row[1].match(new RegExp(`${p.name}x(\\d+)`));
                    if(match) stats[p.name] += parseInt(match[1]);
                });
                totalMoney += parseInt(row[2]);
            });

            for(let key in stats) {
                if(stats[key] > 0) {
                    summary.innerHTML += `<div class="summary-item"><span>${key}</span><span>${stats[key]} æ–¤</span></div>`;
                }
            }
            if(summary.innerHTML === '') summary.innerHTML = 'å°šç„¡å‹¾é¸å“é …';
            document.getElementById('allMoney').innerText = totalMoney;
        } catch(e) {
            document.getElementById('shopSummary').innerText = "è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª GAS æ˜¯å¦éƒ¨ç½²ç‚ºã€Œæ‰€æœ‰äººã€ä¸¦æ›´æ–°ç‰ˆæœ¬ã€‚";
        }
    }

    async function submitOrder() {
        const name = document.getElementById('userName').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥å§“åï¼");
        
        let details = [];
        let total = 0;
        document.querySelectorAll('.qty').forEach(s => {
            if(parseInt(s.value) > 0) {
                details.push(`${products[s.dataset.idx].name}x${s.value}`);
                total += parseInt(s.value) * products[s.dataset.idx].price;
            }
        });

        if(total === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å“é …ï¼");
        
        const btn = document.getElementById('sendBtn');
        btn.disabled = true;
        btn.innerText = "å‚³é€ä¸­...";

        try {
            await fetch(gasUrl, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ name: name, orderString: details.join(', '), total: total })
            });
            alert("ğŸ‰ è¨‚è³¼æˆåŠŸï¼");
            location.reload();
        } catch(e) {
            alert("å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            btn.disabled = false;
        }
    }

    async function deleteOrder(name, time) {
        if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€åœ¨ ${time} çš„è¨‚å–®å—ï¼Ÿ`)) return;
        
        try {
            await fetch(gasUrl, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: "delete", name: name, timestamp: time })
            });
            alert("å·²æˆåŠŸåˆªé™¤ï¼");
            loadOrders(); // é‡æ–°æ•´ç†åˆ—è¡¨
        } catch
