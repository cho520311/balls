<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°ç«¹é­šä¸¸æ¡è³¼åœ˜ - åº—å®¶æ•´åˆç‰ˆ</title>
    <style>
        :root { --primary: #2e59a7; --secondary: #f39c12; }
        body { font-family: sans-serif; background: #f4f4f4; padding: 15px; margin: 0; }
        .card { max-width: 550px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2, h3 { text-align: center; color: var(--primary); }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        select { padding: 8px; border-radius: 5px; font-size: 16px; width: 80px; }
        .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; margin-top: 15px; }
        .btn:disabled { background: #ccc; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
        
        /* åº—å®¶çµ±è¨ˆå€ */
        .summary-card { max-width: 550px; margin: auto; background: #fff3e0; padding: 20px; border-radius: 12px; border: 2px solid var(--secondary); }
        .summary-item { display: flex; justify-content: space-between; padding: 5px 0; font-weight: bold; color: #e67e22; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸš æ–°ç«¹é­šä¸¸æ¡è³¼ç™»è¨˜</h2>
    <label><b>è¨‚è³¼äººå§“åï¼š</b></label>
    <input type="text" id="name" style="width:100%; padding:10px; box-sizing:border-box; margin:10px 0 20px 0;" placeholder="è«‹è¼¸å…¥å§“å">
    
    <div id="itemList">
        </div>
    
    <h3 style="text-align:right; color:#d9534f;">ç¸½é‡‘é¡ï¼šNT$ <span id="totalPrice">0</span></h3>
    <button class="btn" id="submitBtn" onclick="send()">ç¢ºèªé€å‡ºè¨‚å–®</button>
</div>

<div class="summary-card">
    <h3>ğŸª åº—å®¶ç¸½å–®çµ±è¨ˆ (å«è²¨ç”¨)</h3>
    <div id="shopSummary">æ­£åœ¨è¨ˆç®—ç¸½é‡...</div>
    <hr>
    <div class="summary-item" style="font-size: 20px;">
        <span>ç¸½æ”¶æ¬¾é‡‘é¡ï¼š</span>
        <span>NT$ <span id="grandTotal">0</span></span>
    </div>
</div>

<div class="card">
    <h3>ğŸ“Š å³æ™‚è¨‚å–®æ˜ç´°</h3>
    <table id="orderTable">
        <thead>
            <tr><th>å§“å</th><th>è¨‚è³¼å…§å®¹</th><th>æ™‚é–“</th></tr>
        </thead>
        <tbody id="orderBody"></tbody>
    </table>
</div>

<script>
    const gasUrl = 'https://script.google.com/macros/s/AKfycbw24jYvYUnwiDHQgzjFS0to1CgTqV1EMeqMh-AzlERDBTObngOdvNSM5GylkvD9v1bpRA/exec'; // ğŸ‘ˆ æ›æˆæ‚¨çš„ç¶²å€
    const products = [
        { name: "åŒ…é¤¡é­šä¸¸", price: 170 },
        { name: "ç„¡åŒ…é¤¡é­šä¸¸", price: 150 },
        { name: "åŸå‘³è²¢ä¸¸", price: 190 },
        { name: "é¦™è‡è²¢ä¸¸", price: 190 },
        { name: "ç¦å·ç‡•ä¸¸", price: 220 },
        { name: "é®®è”¥è²¢ä¸¸", price: 220 }
    ];

    // åˆå§‹åŒ–é¸å–®
    const container = document.getElementById('itemList');
    products.forEach((p, index) => {
        let options = '';
        for(let i=0; i<=10; i++) options += `<option value="${i}">${i}</option>`; // è¨­å®šç‚º 10 å€‹
        container.innerHTML += `
            <div class="item">
                <span>${p.name} (${p.price}å…ƒ)</span>
                <select class="qty" data-index="${index}">${options}</select>
            </div>`;
    });

    // è¨ˆç®—ç¸½é‡‘é¡
    document.addEventListener('change', () => {
        let total = 0;
        document.querySelectorAll('.qty').forEach(s => {
            total += s.value * products[s.dataset.index].price;
        });
        document.getElementById('totalPrice').innerText = total;
    });

    async function fetchOrders() {
        const resp = await fetch(gasUrl);
        const data = await resp.json();
        const tbody = document.getElementById('orderBody');
        const summaryDiv = document.getElementById('shopSummary');
        tbody.innerHTML = '';
        
        let stats = {};
        products.forEach(p => stats[p.name] = 0);
        let grandTotal = 0;

        data.reverse().forEach(row => {
            // å¯«å…¥æ˜ç´°è¡¨æ ¼
            tbody.innerHTML += `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[3]}</td></tr>`;
            
            // è§£æè³‡æ–™çµ¦åº—å®¶çµ±è¨ˆ (æ ¼å¼: å“é …xæ•¸é‡)
            products.forEach(p => {
                const regex = new RegExp(`${p.name}x(\\d+)`);
                const match = row[1].match(regex);
                if (match) stats[p.name] += parseInt(match[1]);
            });
            grandTotal += parseInt(row[2]);
        });

        // é¡¯ç¤ºåº—å®¶çµ±è¨ˆ
        summaryDiv.innerHTML = '';
        for (let key in stats) {
            if (stats[key] > 0) {
                summaryDiv.innerHTML += `<div class="summary-item"><span>${key}ï¼š</span><span>${stats[key]} æ–¤</span></div>`;
            }
        }
        document.getElementById('grandTotal').innerText = grandTotal;
    }

    async function send() {
        const name = document.getElementById('name').value.trim();
        if (!name) return alert("è«‹è¼¸å…¥å§“å");
        
        let details = [];
        let total = 0;
        document.querySelectorAll('.qty').forEach(s => {
            if (s.value > 0) {
                const p = products[s.dataset.index];
                details.push(`${p.name}x${s.value}`);
                total += s.value * p.price;
            }
        });

        if (total === 0) return alert("è«‹é¸æ“‡å“é …");
        
        document.getElementById('submitBtn').disabled = true;
        await fetch(gasUrl, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ name: name, orderString: details.join(', '), total: total })
        });
        
        alert("è¨‚è³¼æˆåŠŸï¼");
        location.reload();
    }

    window.onload = fetchOrders;
</script>
</body>
</html>
